---
layout: post
title: '[DDIA读书笔记] 《Design Data-Intensive Applications》简介 (一)'
date: 2020-11-02 13:02:49 +0000 UTC
tag: DDIA读书笔记
excerpt: '怎么知道这本书的第一次被推荐《Design Data-Intensive Applications》这本书是在学校的Cloud Computing的课上，老师绘声绘色的形容这本书说这本书不仅涵盖了Cloud Computing的内容，你们如果要做system design的面试，也会对你们帮助...'
---
## 怎么知道这本书的
第一次被推荐《Design Data-Intensive Applications》这本书是在学校的Cloud Computing的课上，老师绘声绘色的形容这本书说这本书不仅涵盖了Cloud Computing的内容，你们如果要做system design的面试，也会对你们帮助很大。并且这是他这两年见过最好的书云云。后来，我不止一次在找工的论坛以及知乎上看到这本书的名字，但是因为种种原因一直没能开始读起来，只是隐约感觉这本书的地位已经和几年前的CSAPP（**C**omputer **S**ystems: **A** **P**rogrammer's **P**erspective）相当了。再之后，我惊喜的发现这本书也有中文版，再加上目前业余时间比较多，就在不长的时间内（小于一个月），把它读完了。我是中文版和英文原版一起读的，主要原因是希望兼顾阅读速度并且不漏掉一些原汁原味的英文术语。我的综合感受是，这本书的翻译质量很高，英文阅读吃力的朋友不妨选择中文版。


## 阅读体验
写读书体验前，首先简单介绍一下我的水平，如果按照国内程序员的细分标准，我应该属于是后端开发工程师。但这本书涉及到的主要内容，和大数据开发工程师的工作相关度比较高（诸如Apache Hadoop，Flink，Spark，Storm，Kafka之类），上述这些Apache的框架我**并没有**在实际工作中使用过。但是因为这本书的内容注重于广度而非深度（当然也可以把泛泛而谈视作缺点），所以我在阅读的时候并没有遇到太多困难。总的来说，我觉得这本书最适合有一定数据库和分布式系统基础的初学者。对于经验丰富的专家的而言，我认为这本书更适合查漏补缺，类似于科研中的review类型的论文，对于参考文献的梳理和索引的重要性大过内容本身。


## 读后感
我认为读这本书的意义是不言自明的。从我的视角来看，基于云服务的数据处理系统已经是大势所趋。集中化的资源（计算和存储）调度的人力和能源成本优势已经不言自明。以前那种自己租个小房间放几台服务器的小作坊模式将不复存在；和云服务商所提供的存储，计算服务打交道将占据程序员们（无论大厂还是小厂）越来越多的时间。这相当于提供了一个新的系统抽象，使程序员可以不再囿于细枝末节，从而可以更轻松的审视自己的业务。而这些了解这类系统如何工作，应该如何设计，就如同现在的程序员们需要多少了解一下计算机系统是如何工作一样。
## 主要内容
书的具体内容方面，作者分了三大章共12章来叙述，结合本书目录，梳理如下：
### 数据基础系统
这一部分主要着重与一些综述，方便读者对现有的知识进行梳理。许多内容都是蜻蜓点水，想要深究的话还得看作者引用的文献。


- 对现代数据系统进行了宏观的介绍与分类
   - 三个维度：可靠性（Reliability），可扩展性（Scalability），和可维护性（Maintainability）
   - 可靠性和可扩展性比较常见，对于可为维护性，作者总结了三个角度：
      - 运维更加轻松 - Operability
      - 新工程师更容易上手 - Simplicity
      - 系统更容易修改和扩展 - Evolvability
         - 这里的扩展（extensibility）不同于可扩展性，指在现有的基础上做出修改来适应更多变的需求
- 讲述了数据模型和对应的查询语言
   - 数据模型
      - 传统的数据库为关系型数据库
      - 与之相对的NoSQL其实是文档型数据库的复苏
      - 两者之间的比较和现状
   - 查询语言
      - 常见的有命令式（imperative）和声明式（declarative）
         - SQL属于声明式，优点是隐藏了实现细节，便于优化
      - 作者还简单介绍了其他的一些和数据操作相关的语言
         - Web上的声明式查询，如CSS的选择器
         - MapReduce语言
         - 图数据库和图查询语言，如Neo4j使用的语言
            - 介绍了SPARQL和Datalog
- 简单介绍了数据的存储和检索
   - 存储
      - 以数据结构入手，主要讲了常见的哈希索引，LSM-Tree（SSTable）和B-Tree
      - 简要提到了聚集索引，覆盖索引，级联索引等
      - 简要介绍了全文搜索和模糊索引，如Lucene
      - 简要介绍了在内存中保存数据
         - 遗憾的是，全书并没有对诸如Memcached和Redis之类的内存数据库做详细介绍
   - OLAP（相对于OLTP）
      - 数据仓库和对应的星型和雪花型分析模式
      - 列式存储
         - 数据的保存，压缩和排序
         - 数据立方体（Data Cube）和物化视图（Materialized View）
- 简单介绍了数据的编码和数据流（Dataflow）
   - 常见的数据编码
      - JSON，XML及类似的二进制编码
      - Thrift，Protocol buffers
      - Apache Avro
   - 数据流和数据建模
      - 以数据库为基础的数据模型，如DAO
      - RPC的组成，数据编码和演化
      - 消息传递系统
         - 消息代理，如Rabbit MQ
         - Actor框架，如Akka（一个基于Scala的消息框架，可以用于微服务系统的实现）
### 分布式数据系统
这一大章可以看作是分布式系统的一个综述，非常适合初学者，我觉得也是对我帮助最大的部分。


- 复制
   - 介绍了主从结构模型的基本架构，
      - 如何切换，如何同步，如何增加新节点，如何处理无效节点
      - 复制日志系统
         - 主从之间传递消息的方式和方法
   - 围绕复制过程中的延迟问题做了更进一步的介绍
      - 三个场景
         - 读自己的写
         - 单调读
         - 前缀一致读
      - 应对不同场景的解决方案
   - 多主复制（Multileader Replication）
      - 常见应用场景
         - 多数据中心
            - 从性能，容错和网络问题三个角度考虑
         - 离线客户端操作
            - 对支持离线操作的APP中产生的数据进行同步的场景
         - 协作编辑，如google docs
      - 如何处理写冲突
         - 冲突检测和避免
         - 自动冲突解决
            - Conflit-free Replicated Datatypes, CRDT
            - Mergeable persistent data
            - Operational transformation
      - 多主复制的拓扑结构以及所面临的问题
   - 无主复制（Leaderless Replication），以Dynamo为例
      - 节点失效应该如何写入数据库
         - 介绍了读修复和反熵
      - 什么是Quorum，Quorum之间的关系
         - “w + r  > n”
      - 如何检测和处理并发写
         - 事件的因果关系
         - 版本向量
- 分区
   - 基本概念
      - 分区和复制间的关系
      - 如何进行分区
         - 关键字，关键字哈希，一致性哈希
      - 分区产生的热点问题
   - 分区和二级索引之间的关系
   - 分区再平衡
      - 再平衡策略
      - 手动或是自动实现分区再平衡
   - 请求路由
      - 不同系统中的路由策略，以Apache Zookeeper为例
- 分布式事务
   - 事务的概念
      - 对ACID的再讨论
      - 单对象事务和多对象事务的区别
   - 弱隔离级别（这里的弱隔离级别是指串行执行以下的隔离级别）
      - 读提交
      - 快照级隔离和重复读
      - 防止更新丢失
      - 写倾斜和幻读
   - 串行化
      - 串行化的实际执行
      - 二阶段锁（2PL）
      - 可串行化的快照隔离（**S**erializable **S**napshot **I**solation）
- 容错
   - 系统本身的故障
      - 软件本身的bug以及分布式系统中的节点部分失效
   - 网络故障
      - 故障的原因及检测
      - 网络延迟
   - 不可靠的时钟
      - 时钟不同步所带来的问题以及解决方法
      - 进程暂停的影响
   - 什么是分布式系统中的“真相”
      - 多数节点达成共识就是真相
      - 分布式理论中的拜占庭问题
      - 分布式理论中的系统模型
- 一致性
   - 线性化
      - 什么是线性化
      - 如何达到线性化
      - CAP理论和对该理论的质疑
   - 顺序保证
      - 顺序与事件的因果关系
      - 根据序列号进行排序
         - Lamport时间戳
      - 全序关系广播（Total Order Broadcast）
         - 全序关系广播，
            - 以ZooKeeper和etcd为例
         - 全序关系广播和线性化之间的关系
   - 分布式事务
      - 二阶段提交（2PC）
      - 支持容错的共识
         - 共识算法的基本要求：协商一致，诚实性，合法性，可终止性
         - 共识算法简介：VSR，Paxos，Raft，Zab
            - 只从算法的性质上做了归类和讨论，并没有叙述具体的实现细节
      - 分布式系统的实际应用
         - 以ZooKeeper和etcd为例
### 派生数据
这一章主要讲解了一下MapReduce为代表的批处理系统和以Apache Kafka为代表的流处理系统。作者在书的最后谈了下对于数据系统的展望。


- 批处理系统
   - 非常有趣的观点：UNIX的命令+管道其实是单机上的批处理系统
      - 设计哲学
         - 统一的接口
         - 业务逻辑与数据存储分离
         - 良好的可观测性，便于测试
   - MapReduce
      - MapReduce基本执行过程
      - Map端Join的各种场景
      - MapReduce系统的应用场景
   - Hadoop
      - HDFS是“文件系统”，而MapReduce是“进程”
   - 如何改进MapReduce
      - Apache Spark和Flink
      - 基于图的批处理
         - Pregel模型
      - 用于批处理系统的新语言和API，如Apache Hive和Pig
         - MapReduce编写过于繁琐，通过使用声明式语言进行抽象
- 流处理系统
   - 数据库和流的关系
      - 使用变更数据捕获（CDD，**C**hange **D**ata **D**etection）从数据库生成流，进而解决数据库同步问题
      - 通过流数据进行事件溯源（Event Sourcing）
      - 流和状态的关系
         - 保存以不可变事件为基础构建的日志
         - 对日志进行流处理来获得状态
   - 流处理
      - 使用场景
         - 流处理，如CEP（**C**omplex **E**vent **P**rocessing）
         - 流分析，如Apache Storm的相关功能
         - 物化视图，如Apache Samza
         - 在流上搜索，如ElasticSearch的percolate功能
            - 这里是指预先设置好搜索条件，然后将流输入到系统，然后触发预设的条件
         - 通过RPC进行事件传递，如actor模型
      - 流处理过程中的时间问题
         - 事件时间和处理时间
         - 窗口机制
   - 流式Join
      - 流和流Join（窗口Join）
      - 流和表Join
      - 表和表Join（物化视图之间的关系维护）
   - 流处理系统中容错的手段
      - 校验点，原子提交，幂等处理，故障后重建
- 数据系统未来
   - 不同数据源的结合以及数据库系统的组件化
   - 更好的可观测性，如流处理系统中每个节点的具体数据都可以更加直观的获得
   - 更完善的跨系统容错
      - 强调事后验证而非事中处理，如区块链技术中的Merkle树
   - 更完善的数据保护机制，更加公平，没有“污染”



在接下来的博客中，我会选择一些感兴趣的话题，以书中的内容为线索，加上一些自己的理解。
